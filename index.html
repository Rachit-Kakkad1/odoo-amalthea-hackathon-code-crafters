<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ExpensoMan - Expense Management</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #eee;
    margin: 0;
    padding: 16px;
    min-height: 100vh;
  }
  #root {
    max-width: 960px;
    margin: auto;
  }
  h1 {
    margin: 0 0 8px;
    color: #66b2ff;
    font-weight: 700;
    text-align: center;
  }
  h2 {
    margin: 0 0 12px;
    color: #80d8ff;
    border-bottom: 1px solid #222;
    padding-bottom: 8px;
  }
  .user-switcher {
    text-align: center;
    margin-bottom: 24px;
  }
  .user-switcher button {
    background: #222;
    border: 1px solid #555;
    color: #eee;
    margin: 0 8px;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .user-switcher button.active,
  .user-switcher button:hover {
    background: #007bff;
    border-color: #007bff;
    color: #fff;
  }
  .dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
    gap: 24px;
  }
  .card {
    background-color: #222;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 0 8px #0008;
  }
  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  li {
    background: #333;
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
  }
  .expense-desc {
    flex: 1 1 60%;
    font-weight: 600;
    word-break: break-word;
  }
  .expense-details {
    flex: 1 1 40%;
    text-align: right;
  }
  .expense-status {
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 9999px;
    text-transform: uppercase;
    user-select: none;
    cursor: default;
  }
  .status-PENDING {
    background-color: #d6a600;
    color: #222;
  }
  .status-APPROVED {
    background-color: #28a745;
    color: white;
  }
  .status-REJECTED {
    background-color: #dc3545;
    color: white;
  }
  button.approve-btn, button.reject-btn {
    margin-left: 12px;
    padding: 6px 16px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button.approve-btn {
    background-color: #28a745;
    color: white;
  }
  button.approve-btn:hover {
    background-color: #218838;
  }
  button.reject-btn {
    background-color: #dc3545;
    color: white;
  }
  button.reject-btn:hover {
    background-color: #a71d2a;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  input, select {
    padding: 10px 14px;
    font-size: 1em;
    border-radius: 6px;
    border: 1px solid #555;
    background-color: #222;
    color: #eee;
  }
  button.submit-btn {
    background-color: #007bff;
    color: white;
    font-size: 1.1em;
    font-weight: 700;
    cursor: pointer;
  }
  button.submit-btn:hover {
    background-color: #0056b3;
  }
  .message {
    margin-top: 16px;
    text-align: center;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 700;
    user-select: none;
  }
  .message.success {
    background-color: #206a49;
    color: #b6eebb;
  }
  .message.error {
    background-color: #7a2424;
    color: #f9b8b8;
  }
  label {
    font-weight: 600;
    margin-bottom: 6px;
  }
  .comment-input {
    resize: vertical;
    min-height: 40px;
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

const {useState, useEffect} = React;

// Predefined users for simulation
const USERS = [
  {id: 1, name: "Admin User", role: "ADMIN", managerId: null},
  {id: 2, name: "Raj (Manager)", role: "MANAGER", managerId: null},
  {id: 3, name: "Priya (Employee)", role: "EMPLOYEE", managerId: 2},
];

// Approval sequence example
const APPROVAL_SEQUENCE = [
  {role: "MANAGER", label: "Manager Approval", isManagerApprover: true},
  {role: "FINANCE", label: "Finance Approval"},
  {role: "DIRECTOR", label: "Director Approval"}
];

// Helper component to render approval steps status
const ApprovalStep = ({step, isCurrent, isDone}) => {
  let bg = "#666";
  if (isDone) bg = "#28a745";
  else if (isCurrent) bg = "#007bff";
  return <span style={{background: bg, color: "white", padding: "4px 12px", borderRadius: "9999px", marginRight: 8, userSelect:"none"}}>{step.label}</span>;
};

function App() {
  const [currentUser, setCurrentUser] = useState(USERS[2]); // default Priya employee
  const [users, setUsers] = useState(USERS);
  const [expenses, setExpenses] = useState([]);
  const [expenseForm, setExpenseForm] = useState({
    amount: "", currency: "INR", category: "", description: "", date: ""
  });
  const [message, setMessage] = useState(null);

  // Helper to get user by id
  const getUserById = (id) => users.find(u => u.id === id);

  // Filtering expenses by logged in user
  const myExpenses = expenses.filter(e => e.employeeId === currentUser.id);

  // Filtering pending expenses *awaiting approval* for manager or admin 
  // (approval must be in correct sequence)
  let approvalQueue = [];
  if(currentUser.role === "MANAGER" || currentUser.role ==="ADMIN") {
    approvalQueue = expenses.filter(exp => {
      if(exp.status !== "PENDING") return false;
      // find the current step in approval sequence
      const step = APPROVAL_SEQUENCE[exp.currentApprovalStep];
      if(!step) return false;
      // manager sees expenses of their own employees *if* they're the current approver
      if(currentUser.role === "MANAGER") {
        return step.isManagerApprover === true && getUserById(exp.employeeId)?.managerId === currentUser.id;
      }
      // admin sees everything except manager step (to avoid duplicate audits)
      if(currentUser.role === "ADMIN") {
        return !step.isManagerApprover;
      }
      return false;
    });
  }

  // Handle form field updates
  function handleChange(e) {
    const {name, value} = e.target;
    setExpenseForm(form => ({...form, [name]: value}));
  }

  // Submit Expense
  function submitExpense(e) {
    e.preventDefault();
    if(!expenseForm.amount || !expenseForm.description || !expenseForm.category || !expenseForm.date) {
      setMessage({type:"error", text:"Please fill all fields."});
      return;
    }
    const newExpense = {
      id: expenses.length + 1,
      employeeId: currentUser.id,
      amount: parseFloat(expenseForm.amount),
      currency: expenseForm.currency,
      category: expenseForm.category,
      description: expenseForm.description,
      date: expenseForm.date,
      status: "PENDING",
      currentApprovalStep: 0, // start at first approver
      comments: []
    };
    setExpenses(exps => [...exps, newExpense]);
    setExpenseForm({amount:"",currency:"INR",category:"",description:"",date:""});
    setMessage({type:"success", text:"Expense submitted."});
  }

  // Approve or reject function
  function handleApproval(expenseId, approved, comment="") {
    setExpenses(exps => exps.map(exp => {
      if(exp.id !== expenseId) return exp;
      const newComments = [...exp.comments, {by: currentUser.name, text: comment, date: new Date().toISOString(), approved}];
      if(!approved) {
        return {...exp, status: "REJECTED", comments: newComments};
      }
      const nextStep = exp.currentApprovalStep + 1;
      if(nextStep >= APPROVAL_SEQUENCE.length) {
        return {...exp, status: "APPROVED", currentApprovalStep: nextStep, comments: newComments};
      }
      return {...exp, currentApprovalStep: nextStep, comments: newComments};
    }));
    setMessage({type:"success", text: approved ? "Expense approved." : "Expense rejected."});
  }

  // Render comments for an expense
  const Comments = ({comments}) => (
    <div style={{fontSize:"0.9em", marginTop:"6px", color:"#ccc"}}>
      <strong>Comments:</strong>
      {comments.length === 0 && <div>None yet.</div>}
      <ul>
        {comments.map((c,i) => (
          <li key={i}>
            <b>{c.by}</b> &middot; {new Date(c.date).toLocaleString()} &middot; <em>{c.approved ? "Approved" : "Rejected"}</em>
            <br />
            {c.text}
          </li>
        ))}
      </ul>
    </div>
  );

  // Admin view: add users
  const [newUserData, setNewUserData] = useState({name:"", role:"EMPLOYEE", managerId:""});
  function handleUserChange(e) {
    const {name, value} = e.target;
    setNewUserData(data => ({...data, [name]: value}));
  }
  function addUser() {
    if(!newUserData.name) {
      setMessage({type:"error", text:"User name required"});
      return;
    }
    const newId = users.length + 1;
    const managerIdNum = newUserData.managerId ? parseInt(newUserData.managerId) : null;
    setUsers(u => [...u, {id:newId, name:newUserData.name, role:newUserData.role, managerId: managerIdNum}]);
    setNewUserData({name:"", role:"EMPLOYEE", managerId:""});
    setMessage({type:"success", text:"User added"});
  }

  return (
    <div>
      <div className="header">
        <h1>ExpensoMan</h1>
        <p>A Simple Expense Management Dashboard</p>
      </div>

      <div className="user-switcher">
        <span>Login as: </span>
        {USERS.map(user => (
          <button 
            key={user.id} 
            className={currentUser.id===user.id ? "active" : ""}
            onClick={() => {setCurrentUser(user); setMessage(null);}}>
            {user.name} ({user.role})
          </button>
        ))}
      </div>

      {message && <div className={`message ${message.type}`}>{message.text}</div>}

      <div className="dashboard">

        {/* Approval queue */}
        {(currentUser.role === "MANAGER" || currentUser.role === "ADMIN") && (
          <div className="card">
            <h2>{currentUser.role==="MANAGER" ? "Team Expenses to Approve" : "Expense Approval Queue"}</h2>
            {approvalQueue.length === 0 && <div>No expenses awaiting your approval.</div>}
            <ul>
              {approvalQueue.map(exp => (
                <li key={exp.id}>
                  <div className="expense-desc">
                    <strong>{getUserById(exp.employeeId)?.name || "Unknown"}</strong>: {exp.description} ({exp.category})
                    <br />
                    Date: {exp.date} &middot; Amount: {exp.amount} {exp.currency}
                    <br />
                    {APPROVAL_SEQUENCE.map((step,i) => (
                      <ApprovalStep 
                        key={i} 
                        step={step} 
                        isCurrent={i === exp.currentApprovalStep} 
                        isDone={i < exp.currentApprovalStep}
                      />
                    ))}
                    <Comments comments={exp.comments} />
                  </div>
                  <div className="expense-details">
                    <textarea 
                      placeholder="Add comment (optional)" 
                      rows="2"
                      onChange={(e) => exp.tempComment = e.target.value}
                      style={{width:"100%", marginBottom:"8px"}}
                    />
                    <button 
                      className="approve-btn" 
                      onClick={() => handleApproval(exp.id, true, exp.tempComment)}
                    >
                      Approve
                    </button>
                    <button 
                      className="reject-btn" 
                      onClick={() => handleApproval(exp.id, false, exp.tempComment)}
                    >
                      Reject
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* My Expenses and Submission */}
        <div className="card">
          <h2>My Submitted Expenses</h2>
          {myExpenses.length === 0 ? (
            <p>You have not submitted any expenses yet.</p>
          ) : (
            <ul>
              {myExpenses.map(exp => (
                <li key={exp.id}>
                  <div className="expense-desc">
                    {exp.description} ({exp.category})
                    <br />
                    Date: {exp.date}
                  </div>
                  <div className="expense-details">
                    {exp.amount.toFixed(2)} {exp.currency}
                    <span className={`expense-status status-${exp.status}`}>
                      {exp.status}
                    </span>
                  </div>
                </li>
              ))}
            </ul>
          )}

          {/* Expense form only for Employees */}
          {currentUser.role === "EMPLOYEE" && (
            <>
              <h2 style={{marginTop:"32px"}}>Submit New Expense</h2>
              <form onSubmit={submitExpense}>
                <label>Amount *</label>
                <input type="number" name="amount" onChange={handleChange} value={expenseForm.amount} min="0" step="0.01" required />

                <label>Currency *</label>
                <select name="currency" onChange={handleChange} value={expenseForm.currency} required>
                  <option value="INR">INR (₹)</option>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="GBP">GBP (£)</option>
                </select>

                <label>Category *</label>
                <input type="text" name="category" onChange={handleChange} value={expenseForm.category} placeholder="e.g. Travel, Food, Supplies" required />

                <label>Description *</label>
                <input type="text" name="description" onChange={handleChange} value={expenseForm.description} placeholder="Brief description" required />

                <label>Date *</label>
                <input type="date" name="date" onChange={handleChange} value={expenseForm.date} required />

                <button type="submit" className="submit-btn">Submit Expense</button>
              </form>
            </>
          )}
        </div>

        {/* Admin panel for user management */}
        {currentUser.role === "ADMIN" && (
          <div className="card" style={{marginTop:"24px"}}>
            <h2>Admin Panel — Manage Users</h2>
            <form onSubmit={e => { e.preventDefault(); addUser(); }}>
              <label>Name *</label>
              <input name="name" value={newUserData?.name || ''} onChange={handleUserChange} placeholder="Full Name" required />
              <label>Role *</label>
              <select name="role" value={newUserData?.role || "EMPLOYEE"} onChange={handleUserChange} required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
              </select>
              <label>Manager (for Employee)</label>
              <select name="managerId" value={newUserData?.managerId || ""} onChange={handleUserChange}>
                <option value="">None</option>
                {users.filter(u => u.role === "MANAGER").map(m => (
                  <option key={m.id} value={m.id}>{m.name}</option>
                ))}
              </select>
              <button type="submit" className="submit-btn">Add User</button>
            </form>

            <h3 style={{marginTop:"24px"}}>All Users</h3>
            <ul>
              {users.map(u => (
                <li key={u.id}>
                  {u.name} ({u.role}) 
                  {u.role === "EMPLOYEE" && u.managerId && ` - Manager: ${getUserById(u.managerId)?.name || "Unknown"}`}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
