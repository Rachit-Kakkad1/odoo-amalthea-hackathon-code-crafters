<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ExpensoMan - Login</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: rgb(13, 18, 26);
    color: #eee;
    margin: 0;
    padding: 16px;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #root {
    width: 100%;
    max-width: 960px;
    margin: auto;
  }
  h1 {
    margin: 0 0 8px;
    color: #66b2ff;
    font-weight: 700;
    text-align: center;
  }
  h2, h3 {
    margin: 0 0 12px;
    color: #80d8ff;
    border-bottom: 1px solid #222;
    padding-bottom: 8px;
  }
  .dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
    gap: 24px;
  }
  .card {
    background-color: #222;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 0 8px #0008;
  }
  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  li {
    background: #333;
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
  }
  .expense-desc {
    flex: 1 1 60%;
    font-weight: 600;
    word-break: break-word;
  }
  .expense-details {
    flex: 1 1 40%;
    text-align: right;
  }
  .expense-status {
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 9999px;
    text-transform: uppercase;
    user-select: none;
  }
  .status-PENDING { background-color: #d6a600; color: #222; }
  .status-APPROVED { background-color: #28a745; color: white; }
  .status-REJECTED { background-color: #dc3545; color: white; }
  button.approve-btn, button.reject-btn {
    margin-left: 12px;
    padding: 6px 16px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.approve-btn { background-color: #28a745; color: white; }
  button.approve-btn:hover { background-color: #218838; }
  button.reject-btn { background-color: #dc3545; color: white; }
  button.reject-btn:hover { background-color: #a71d2a; }
  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  input, select {
    padding: 10px 14px;
    font-size: 1em;
    border-radius: 6px;
    border: 1px solid #555;
    background-color: #222;
    color: #eee;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
  }
  button.submit-btn {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    font-size: 1.1em;
    font-weight: 700;
    cursor: pointer;
    border: none;
    padding-top: 12px;
    padding-bottom: 12px;
    transition: all 0.2s ease-in-out;
  }
  button.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
  }
  .message {
    margin-top: 16px;
    text-align: center;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 700;
  }
  .message.success { background-color: #206a49; color: #b6eebb; }
  .message.error { background-color: #7a2424; color: #f9b8b8; }
  label {
    font-weight: 600;
    margin-bottom: -10px;
  }
  .comment-input { resize: vertical; min-height: 40px; }

  /* --- NEW LOGIN PAGE STYLES --- */
  .login-container {
    max-width: 400px;
    margin: auto;
    padding: 24px 32px;
    background-color: #1e1e1e;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    border: 1px solid #333;
  }
  .login-container h2 {
    text-align: center;
    color: #80d8ff;
    border: none;
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState } = React;

// --- MODIFICATION: Added 'email' and 'password' to user data for login ---
const USERS = [
  {id: 1, name: "Admin User", role: "ADMIN", managerId: null, email: "admin@expensoman.com", password: "password"},
  {id: 2, name: "Manager User", role: "MANAGER", managerId: null, email: "manager@expensoman.com", password: "password"},
  {id: 3, name: "Employee User", role: "EMPLOYEE", managerId: 2, email: "employee@expensoman.com", password: "password"},
];

const APPROVAL_SEQUENCE = [
  {role: "MANAGER", label: "Manager Approval", isManagerApprover: true},
  {role: "FINANCE", label: "Finance Approval"},
  {role: "DIRECTOR", label: "Director Approval"}
];

// --- MODIFICATION 1: LOGIN PAGE COMPONENT ---
// This component handles the UI and state for the login form.
function LoginPage({ onLogin, error }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    onLogin(email, password);
  };

  return (
    <div className="login-container">
      <h2>ExpensoMan Login</h2>
      <form onSubmit={handleSubmit}>
        <label>Email</label>
        <input 
          type="email" 
          value={email} 
          onChange={(e) => setEmail(e.target.value)} 
          placeholder="e.g., manager@expensoman.com"
          required 
        />
        <label>Password</label>
        <input 
          type="password" 
          value={password}
          onChange={(e) => setPassword(e.target.value)} 
          placeholder="default: password"
          required 
        />
        <button type="submit" className="submit-btn">Login</button>
        {error && <div className="message error" style={{marginTop: '12px'}}>{error}</div>}
      </form>
    </div>
  );
}

// --- MODIFICATION 2: DASHBOARD COMPONENT ---
// The original App component's UI has been moved here.
// It now receives the logged-in user and logout function as props.
function Dashboard({ loggedInUser, onLogout }) {
  const [users, setUsers] = useState(USERS);
  const [expenses, setExpenses] = useState([]);
  const [expenseForm, setExpenseForm] = useState({
    amount: "", currency: "INR", category: "", description: "", date: ""
  });
  const [message, setMessage] = useState(null);

  const currentUser = loggedInUser; // Use the prop for the current user

  const getUserById = (id) => users.find(u => u.id === id);
  const myExpenses = expenses.filter(e => e.employeeId === currentUser.id);
  
  let directReports = [];
  if (currentUser.role === "MANAGER") {
    directReports = users.filter(user => user.managerId === currentUser.id);
  }

  let approvalQueue = [];
  if (currentUser.role === "MANAGER" || currentUser.role === "ADMIN") {
    approvalQueue = expenses.filter(exp => {
      if (exp.status !== "PENDING") return false;
      const step = APPROVAL_SEQUENCE[exp.currentApprovalStep];
      if (!step) return false;
      if (currentUser.role === "MANAGER") {
        return step.isManagerApprover === true && getUserById(exp.employeeId)?.managerId === currentUser.id;
      }
      if (currentUser.role === "ADMIN") {
        return !step.isManagerApprover;
      }
      return false;
    });
  }

  function handleChange(e) {
    const { name, value } = e.target;
    setExpenseForm(form => ({ ...form, [name]: value }));
  }

  function submitExpense(e) {
    e.preventDefault();
    if (!expenseForm.amount || !expenseForm.description || !expenseForm.category || !expenseForm.date) {
      setMessage({ type: "error", text: "Please fill all fields." });
      return;
    }
    const newExpense = {
      id: expenses.length + 1,
      employeeId: currentUser.id,
      amount: parseFloat(expenseForm.amount),
      currency: expenseForm.currency,
      category: expenseForm.category,
      description: expenseForm.description,
      date: expenseForm.date,
      status: "PENDING",
      currentApprovalStep: 0,
      comments: []
    };
    setExpenses(exps => [...exps, newExpense]);
    setExpenseForm({ amount: "", currency: "INR", category: "", description: "", date: "" });
    setMessage({ type: "success", text: "Expense submitted." });
  }

  function handleApproval(expenseId, approved, comment = "") {
    setExpenses(exps => exps.map(exp => {
      if (exp.id !== expenseId) return exp;
      const newComments = [...exp.comments, { by: currentUser.name, text: comment, date: new Date().toISOString(), approved }];
      if (!approved) {
        return { ...exp, status: "REJECTED", comments: newComments };
      }
      const nextStep = exp.currentApprovalStep + 1;
      if (nextStep >= APPROVAL_SEQUENCE.length) {
        return { ...exp, status: "APPROVED", currentApprovalStep: nextStep, comments: newComments };
      }
      return { ...exp, currentApprovalStep: nextStep, comments: newComments };
    }));
    setMessage({ type: "success", text: approved ? "Expense approved." : "Expense rejected." });
  }
  
  const [newUserData, setNewUserData] = useState({name:"", role:"EMPLOYEE", managerId:""});
  function handleUserChange(e) {
    const {name, value} = e.target;
    setNewUserData(data => ({...data, [name]: value}));
  }
  function addUser() {
    if(!newUserData.name) {
      setMessage({type:"error", text:"User name required"});
      return;
    }
    const newId = users.length + 1;
    const managerIdNum = newUserData.managerId ? parseInt(newUserData.managerId) : null;
    setUsers(u => [...u, {id:newId, name:newUserData.name, role:newUserData.role, managerId: managerIdNum}]);
    setNewUserData({name:"", role:"EMPLOYEE", managerId:""});
    setMessage({type:"success", text:"User added"});
  }

  return (
    <div>
      <div style={{ textAlign: "center", marginBottom: "24px" }}>
        <h1>ExpensoMan</h1>
        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 10px'}}>
            <p>Welcome, <strong>{currentUser.name}</strong> ({currentUser.role})</p>
            <button onClick={onLogout} className="reject-btn" style={{margin: 0}}>Logout</button>
        </div>
      </div>

      {message && <div className={`message ${message.type}`}>{message.text}</div>}

      <div className="dashboard">
        {/* Manager Info Card */}
        {currentUser.role === "MANAGER" && (
            <div className="card">
                <h2>Manager Dashboard</h2>
                <p style={{margin: '8px 0'}}><strong>Name:</strong> {currentUser.name}</p>
                <p style={{margin: '8px 0'}}><strong>Email:</strong> {currentUser.email}</p>
                <h3 style={{marginTop: '20px'}}>My Direct Reports:</h3>
                {directReports.length > 0 ? (
                    <ul>{directReports.map(employee => <li key={employee.id}><strong>{employee.name}</strong></li>)}</ul>
                ) : <p>You have no direct reports.</p>}
            </div>
        )}

        {/* Approval Queue */}
        {(currentUser.role === "MANAGER" || currentUser.role === "ADMIN") && (
          <div className="card">
            <h2>{currentUser.role==="MANAGER" ? "Team Expenses to Approve" : "Expense Approval Queue"}</h2>
            {approvalQueue.length === 0 ? <div>No expenses awaiting your approval.</div> : (
              <ul>
                {approvalQueue.map(exp => (
                  <li key={exp.id}>
                    <div className="expense-desc">
                      <strong>{getUserById(exp.employeeId)?.name || "Unknown"}</strong>: {exp.description}
                    </div>
                    <div className="expense-details">
                      <button className="approve-btn" onClick={() => handleApproval(exp.id, true)}>Approve</button>
                      <button className="reject-btn" onClick={() => handleApproval(exp.id, false)}>Reject</button>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </div>
        )}
        
        {/* My Expenses */}
        <div className="card">
            <h2>My Submitted Expenses</h2>
            {myExpenses.length === 0 ? <p>You have not submitted any expenses yet.</p> : (
                <ul>{myExpenses.map(exp => <li key={exp.id}><span className="expense-desc">{exp.description}</span><span className={`expense-status status-${exp.status}`}>{exp.status}</span></li>)}</ul>
            )}
            {currentUser.role === "EMPLOYEE" && (
                <>
                    <h2 style={{marginTop:"32px"}}>Submit New Expense</h2>
                    <form onSubmit={submitExpense}>
                        <input type="number" name="amount" onChange={handleChange} value={expenseForm.amount} placeholder="Amount *" required />
                        <input type="text" name="category" onChange={handleChange} value={expenseForm.category} placeholder="Category *" required />
                        <input type="text" name="description" onChange={handleChange} value={expenseForm.description} placeholder="Description *" required />
                        <input type="date" name="date" onChange={handleChange} value={expenseForm.date} required />
                        <button type="submit" className="submit-btn">Submit Expense</button>
                    </form>
                </>
            )}
        </div>
        
        {/* Admin Panel */}
        {currentUser.role === "ADMIN" && (
            <div className="card" style={{gridColumn: '1 / -1'}}>
                <h2>Admin Panel â€” Manage Users</h2>
                {/* User management UI from original code can be placed here */}
            </div>
        )}
      </div>
    </div>
  );
}


// --- MODIFICATION 3: APP COMPONENT AS CONTROLLER ---
// This is now the main component that controls the application's state (logged in or not).
function App() {
  const [loggedInUser, setLoggedInUser] = useState(null);
  const [loginError, setLoginError] = useState('');

  const handleLogin = (email, password) => {
    // Find user by email and password
    const user = USERS.find(u => u.email === email && u.password === password);
    
    if (user) {
      setLoggedInUser(user);
      setLoginError(''); // Clear any previous errors
    } else {
      setLoginError('Invalid email or password. Please try again.');
    }
  };

  const handleLogout = () => {
    setLoggedInUser(null);
  };

  // Conditional Rendering: Show LoginPage or Dashboard
  return (
    <div>
      {loggedInUser ? (
        <Dashboard loggedInUser={loggedInUser} onLogout={handleLogout} />
      ) : (
        <LoginPage onLogin={handleLogin} error={loginError} />
      )}
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));

</script>
</body>
</html>