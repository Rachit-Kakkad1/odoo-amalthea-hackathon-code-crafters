<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LedgerCore - Expense Management</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">


<style>
    :root {
        --primary-color: #8b5cf6; /* A slightly brighter purple for dark mode */
        --primary-color-darker: #2575fc;
        --solid-black: #111827; /* Dark blue-gray background */
        --text-color: #F9FAFB; /* Off-white text */
        --text-color-muted: #9CA3AF; /* Lighter gray for muted text */
        --card-bg-dark: rgba(31, 41, 55, 0.5); 
        --card-border-dark: rgba(255, 255, 255, 0.1);
    }
    html {
        background-color: var(--solid-black);
    }
    body {
        font-family: "Segoe UI", "Poppins", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--solid-black);
        color: var(--text-color);
        margin: 0;
        min-height: 100vh;
    }
    #root {
        width: 100%;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-sizing: border-box;
        position: relative;
        overflow-x: hidden;
    }
    
    .view-container {
        width: 100%;
        display: flex;
        justify-content: center;
        animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* --- Landing Page Styles --- */
    .landing-page {
        width: 100%;
        color: var(--text-color);
        background-color: #111827;
    }
    .landing-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        max-width: 1280px;
        margin: 0 auto;
    }
    .landing-nav .logo { font-weight: 700; font-size: 1.5rem; color: #F9FAFB; }
    .landing-nav .nav-links a { margin: 0 1rem; text-decoration: none; color: var(--text-color-muted); font-weight: 600; }
    .landing-nav .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
    .landing-nav .btn:hover { background-color: #7c3aed; }

    .hero-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4rem 2rem;
        max-width: 1280px;
        margin: 0 auto;
        gap: 2rem;
    }
    .hero-content {
        max-width: 500px;
    }
    .hero-content h1 {
        font-size: 3.5rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 1rem;
        color: #F9FAFB;
    }
    .hero-content p {
        font-size: 1.1rem;
        color: var(--text-color-muted);
        margin-bottom: 2rem;
    }
    .hero-buttons .btn { margin-right: 1rem; }
    .hero-buttons .btn-secondary { background-color: #374151; color: var(--text-color); }
     .hero-buttons .btn-secondary:hover { background-color: #4B5563; }

    .hero-image img {
        width: 100%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .trusted-section {
        background-color: #1F2937;
        padding: 3rem 2rem;
        text-align: center;
    }
    .trusted-section h3 {
        color: var(--text-color-muted);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 2rem;
    }
    .logos {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 3rem;
        filter: grayscale(100%) invert(1);
        opacity: 0.6;
    }

    /* --- Auth Page (Login/Sign Up) Styles --- */
    .auth-wrapper {
        width: 100%;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    
    .signup-box {
        background: var(--card-bg-dark);
        backdrop-filter: blur(15px);
        border: 1px solid var(--card-border-dark);
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 420px;
        text-align: center;
    }
    .signup-box h2 {
        border: none;
        padding-bottom: 0;
        margin-bottom: 10px;
        color: var(--text-color);
        font-size: 28px;
        text-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
    }
    .signup-box p {
        color: var(--text-color-muted);
        margin-bottom: 30px;
    }
    .auth-wrapper .input-group {
        position: relative;
        margin-bottom: 25px;
        text-align: left;
    }
    .auth-wrapper input, .auth-wrapper select {
        width: 100%;
        padding: 14px;
        box-sizing: border-box;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: transparent;
        color: var(--text-color);
        outline: none;
        transition: all 0.3s;
    }
    .auth-wrapper input::placeholder { color: transparent; }
    .auth-wrapper label {
        position: absolute;
        top: 15px;
        left: 15px;
        color: var(--text-color-muted);
        pointer-events: none;
        transition: all 0.3s ease-out;
    }
    .auth-wrapper input:focus + label, .auth-wrapper input:not(:placeholder-shown) + label {
        top: -10px;
        left: 10px;
        transform: scale(0.85);
        background-color: var(--primary-color);
        padding: 2px 8px;
        border-radius: 4px;
        color: #fff;
        font-weight: 600;
    }
    .auth-wrapper button[type="submit"] {
        width: 100%;
        padding: 14px;
        background-color: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease-out;
        margin-top: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
     .auth-wrapper button[type="submit"]:hover {
        background-color: #7c3aed;
    }
    .login-link { color: var(--text-color-muted); }
    .login-link a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 700;
        cursor: pointer;
    }
    .role-selector { display: flex; gap: 10px; margin-bottom: 25px; }
    .role-selector button {
        flex: 1;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: var(--text-color-muted);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    .role-selector button.active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
    }
    
    /* --- Dashboard Styles --- */
    .dashboard-wrapper {
        max-width: 1280px;
        width: 100%;
        margin: auto;
        position: relative;
        z-index: 1;
        padding: 1rem;
    }
    .dashboard h2, .dashboard h3 {
        margin: 1rem 0 0.75rem;
        color: var(--primary-color);
        border-bottom: 1px solid #374151;
        padding-bottom: 8px;
    }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); gap: 24px; }
    .card {
        background-color: #1F2937;
        border: 1px solid #374151;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    ul { list-style: none; margin: 0; padding: 0; }
    li {
        background: #374151;
        margin-bottom: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #4B5563;
    }
    button.approve-btn, button.reject-btn, button.logout-btn { margin-left: 12px; padding: 6px 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
    button.approve-btn { background-color: #16a34a; color: white; }
    button.reject-btn, button.logout-btn { background-color: #dc2626; color: white; }
    .message { margin-top: 16px; text-align: center; padding: 12px 16px; border-radius: 8px; font-weight: 700; }
    .message.error { background-color: #7f1d1d; color: #fecaca; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .summary-card {
        background: #1F2937;
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #374151;
    }
    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    .summary-card .label {
        font-size: 0.9rem;
        color: var(--text-color-muted);
    }

    .dashboard-wrapper input, .dashboard-wrapper select {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid #4B5563;
        border-radius: 8px;
        background-color: #374151;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }
    .dashboard-wrapper form input, .dashboard-wrapper form select {
        margin-bottom: 1rem;
    }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- IMPORTANT: LINK TO YOUR BACKEND HERE ---
// This is the single place to change the URL for your backend server.
const API_URL = 'http://127.0.0.1:8000';

// --- COMPONENT 1: PROFESSIONAL LANDING PAGE ---
function LandingPage({ switchToLogin, switchToSignUp }) {
    return (
        <div className="landing-page">
            <nav className="landing-nav">
                <div className="logo">LedgerCore</div>
                <div className="nav-links">
                    <a href="#">Solutions</a>
                    <a href="#">Platform</a>
                    <a href="#">Pricing</a>
                    <a href="#">Company</a>
                </div>
                <div>
                    <button className="btn" onClick={switchToLogin}>Login</button>
                </div>
            </nav>

            <section className="hero-section">
                <div className="hero-content">
                    <h1>Expense management software</h1>
                    <p>Choose expense management software that shows you employee expenses in real time. Monitor team budgets, track requests and approvals, reimburse expenses, and embrace admin.</p>
                    <div className="hero-buttons">
                        <button className="btn" onClick={switchToSignUp}>Start a demo</button>
                        <button className="btn btn-secondary">Try it out</button>
                    </div>
                </div>
                <div className="hero-image">
                    <img src="https://res.cloudinary.com/ddmt5vrxi/image/upload/v1759568782/WhatsApp_Image_2025-10-04_at_14.32.14_bb031eed_rhiykz.jpg" alt="Expense management app screenshot" />
                </div>
            </section>

            <section className="trusted-section">
                <h3>THOUSANDS OF WORLD-CLASS COMPANIES STREAMLINE EXPENSES WITH LedgerCore</h3>
                <div className="logos">
                    <span>ALGOLIA</span>
                    <span>ITRS</span>
                    <span>Habito</span>
                    <span>SECURA</span>
                    <span>NICKEL</span>
                </div>
            </section>
        </div>
    );
}

// --- COMPONENT 2: SIGN UP PAGE ---
function SignUpPage({ onSignUp, switchToLogin, error }) {
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [role, setRole] = useState('EMPLOYEE');
    const handleSubmit = (e) => { e.preventDefault(); onSignUp({ name, email, password, confirmPassword, role }); };

    return (
        <div className="auth-wrapper">
             <div className="signup-box">
                <h2>Create Your Account</h2>
                <form onSubmit={handleSubmit}>
                    <div className="input-group"><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder=" " required /><label>Full Name</label></div>
                    <div className="input-group"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder=" " required /><label>Email</label></div>
                    <div className="input-group">
                         <div className="role-selector">
                             <button type="button" onClick={() => setRole('EMPLOYEE')} className={role === 'EMPLOYEE' ? 'active' : ''}>Employee</button>
                             <button type="button" onClick={() => setRole('MANAGER')} className={role === 'MANAGER' ? 'active' : ''}>Manager</button>
                             <button type="button" onClick={() => setRole('ADMIN')} className={role === 'ADMIN' ? 'active' : ''}>Admin</button>
                         </div>
                    </div>
                    <div className="input-group"><input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder=" " required minLength="8" /><label>Password</label></div>
                    <div className="input-group"><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} placeholder=" " required /><label>Confirm Password</label></div>
                    <button type="submit">Sign Up</button>
                </form>
                {error && <div className="message error">{error}</div>}
                <div className="login-link">Already have an account? <a onClick={switchToLogin}>Log In</a></div>
            </div>
        </div>
    );
}

// --- COMPONENT 3: LOGIN PAGE ---
function LoginPage({ onLogin, switchToSignUp, error }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const handleSubmit = (e) => { e.preventDefault(); onLogin(email, password); };

  return (
    <div className="auth-wrapper">
        <div className="signup-box">
            <h2>Welcome Back</h2>
            <form onSubmit={handleSubmit}>
                <div className="input-group"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder=" " required /><label>Email</label></div>
                <div className="input-group"><input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder=" " required /><label>Password</label></div>
                <button type="submit">Login</button>
            </form>
            {error && <div className="message error">{error}</div>}
            <div className="login-link">Don't have an account? <a onClick={switchToSignUp}>Sign Up</a></div>
        </div>
    </div>
  );
}

// --- COMPONENT 4: EMPLOYEE DASHBOARD (IFRAME) ---
function EmployeeDashboardPro({loggedInUser}){
    const dashboardHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"/><title>Expense Tracker Pro</title><meta name="viewport" content="width=device-width,initial-scale=1"/><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script><style>:root{--bg-1:linear-gradient(135deg,#0b1220,#08101a);--card-bg:rgba(255,255,255,.03);--muted:rgba(255,255,255,.6);--accent:#2ecc71;--accent-2:#4facfe;--danger:#ff6b6b;--shadow:0 12px 40px rgba(2,6,23,.55);--radius:14px;--glass-border:rgba(255,255,255,.04)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:"Poppins","Inter",sans-serif;background:var(--bg-1);color:#e8eef6;padding:28px}.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:22px;align-items:start}@media (max-width:980px){.container{grid-template-columns:1fr}}.btn{background:rgba(255,255,255,.04);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .12s ease}.btn:hover{transform:translateY(-2px)}.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}.card{background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid var(--glass-border);backdrop-filter:blur(10px)}.input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.03);color:#eaf4ff}.label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}table{width:100%;border-collapse:collapse;color:#e9f6ff}thead th{padding:12px 14px;text-align:left;background:rgba(255,255,255,.02)}tbody td{padding:12px 14px;border-top:1px dashed rgba(255,255,255,.03)}.sidebar{display:flex;flex-direction:column;gap:14px}.total-amount{font-size:22px;font-weight:800;color:var(--accent-2)}.charts canvas{width:100%!important;height:230px!important}.toast-wrap{position:fixed;right:18px;bottom:18px;z-index:1200;display:flex;flex-direction:column;gap:8px}.toast{background:rgba(0,0,0,.6);color:#fff;padding:10px 14px;border-radius:10px;font-weight:600}<\/style><\/head><body><div class="toast-wrap" id="toasts"><\/div><div class="container"><div><h1>Hello, ${loggedInUser.name}<\/h1><p class="muted">This is your personal expense dashboard.<\/p><main class="card"><form id="expenseForm" style="display:flex;gap:18px;flex-wrap:wrap;align-items:flex-end"><div><label class="label">Name / Description<\/label><input id="name" class="input" required><\/div><div><label class="label">Amount<\/label><input id="amount" class="input" type="number" required><\/div><div><label class="label">Category<\/label><input id="category" class="input" required><\/div><div><label class="label">Date<\/label><input id="date" class="input" type="date" required><\/div><div><button class="btn primary" type="submit">➕ Add Expense<\/button><\/div><\/form><section style="margin-top:18px"><table><thead><tr><th>Name<\/th><th>Amount<\/th><th>Category<\/th><th>Date<\/th><th>Action<\/th><\/tr><\/thead><tbody id="expensesTable"><\/tbody><\/table><\/section><\/main><\/div><aside class="sidebar"><div class="card"><div class="small">Total Unsubmitted Expenses<\/div><div class="total-amount" id="totalAmount">0<\/div><\/div><div class="card charts"><strong>Category Breakdown<\/strong><canvas id="categoryChart"><\/canvas><\/div><div class="card"><button class="btn primary" id="submitAllBtn" style="width:100%">🚀 Submit All for Approval<\/button><\/div><\/aside><\/div><script>let expenses=[];const STORAGE_KEY="et_pro_temp_expenses_v2_${loggedInUser.id}";let categoryChart;const uid=()=>"id_"+Math.random().toString(36).slice(2,9);const formatCurrency=e=>"₹"+Number(e).toLocaleString("en-IN",{minimumFractionDigits:2});const toast=(e,t="success")=>{const o=document.createElement("div");o.className="toast",o.innerText=e,o.style.backgroundColor="error"===t?"#c00":"#050",document.getElementById("toasts").appendChild(o),setTimeout(()=>{o.remove()},3e3)},saveLocal=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(expenses)),loadLocal=()=>JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"),escapeHtml=e=>String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])),renderTable=()=>{document.getElementById("expensesTable").innerHTML=expenses.map(e=>\`<tr><td>\${escapeHtml(e.name)}</td><td>\${formatCurrency(e.amount)}</td><td>\${escapeHtml(e.category)}</td><td>\${escapeHtml(e.date)}</td><td><button class="btn" onclick="deleteExpense('\${e.id}')">🗑️</button></td></tr>\`).join("")},updateUI=()=>{const e=expenses.reduce((e,t)=>e+t.amount,0);document.getElementById("totalAmount").innerText=formatCurrency(e);const t=expenses.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+t.amount,e),{});const o=document.getElementById("categoryChart").getContext("2d");categoryChart&&categoryChart.destroy(),categoryChart=new Chart(o,{type:"doughnut",data:{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:["#3498db","#2ecc71","#f1c40f","#e74c3c","#9b59b6"]}]},options:{plugins:{legend:{display:!1}}}}),renderTable()},window.deleteExpense=e=>{expenses=expenses.filter(t=>t.id!==e),saveLocal(),updateUI()},document.getElementById("expenseForm").addEventListener("submit",e=>{e.preventDefault();const t={id:uid(),name:e.target.name.value,amount:parseFloat(e.target.amount.value),category:e.target.category.value,date:e.target.date.value};expenses.push(t),saveLocal(),updateUI(),e.target.reset(),document.getElementById("date").value=(new Date).toISOString().slice(0,10),toast("Expense saved locally.")}),document.getElementById("submitAllBtn").addEventListener("click",()=>{0===expenses.length?toast("No expenses to submit.","error"):(window.parent.postMessage({type:"SUBMIT_EXPENSES",payload:expenses},"*"),expenses=[],saveLocal(),updateUI(),toast("All expenses submitted for approval!"))}),(()=>{expenses=loadLocal(),document.getElementById("date").value=(new Date).toISOString().slice(0,10),updateUI()})();<\/script><\/body><\/html>`;
    return <iframe srcDoc={dashboardHtml} style={{width:"100%",height:"calc(100vh - 80px)",border:"none",borderRadius:"12px"}} title="Advanced Employee Dashboard" />;
};

// --- COMPONENT 5: MANAGER & ADMIN DASHBOARD ---
function ManagerAdminDashboard({ loggedInUser, authToken, allUsers, setUsers, expenses, setExpenses }) {
    const chartRef = useRef(null);
    const [monthlyBudget, setMonthlyBudget] = useState(50000);
    const [budgetInput, setBudgetInput] = useState(50000);

    const isManager = loggedInUser.role === 'MANAGER';
    const myTeamMemberIds = isManager ? allUsers.filter(u => u.managerId === loggedInUser.id).map(u => u.id) : [];
    
    // In admin view, relevantExpenses is all expenses. In manager view, it's just their team's.
    const relevantExpenses = isManager ? expenses.filter(e => myTeamMemberIds.includes(e.employeeId)) : expenses;
    
    const pendingExpenses = relevantExpenses.filter(e => e.status === 'PENDING');
    const approvedThisMonth = relevantExpenses.filter(e => {
        const today = new Date();
        const expenseDate = new Date(e.date);
        return e.status === 'APPROVED' && expenseDate.getMonth() === today.getMonth() && expenseDate.getFullYear() === today.getFullYear();
    });

    const pendingValue = pendingExpenses.reduce((sum, e) => sum + e.amount, 0);
    const approvedValue = approvedThisMonth.reduce((sum, e) => sum + e.amount, 0);

    const formatCurrency = val => `₹${Number(val).toLocaleString('en-IN')}`;
    const budgetSpentPercent = monthlyBudget > 0 ? (approvedValue / monthlyBudget) * 100 : 0;

    useEffect(() => {
        if (!chartRef.current) return;
        const ctx = chartRef.current.getContext('2d');
        
        Chart.defaults.color = '#9CA3AF'; // Set default font color for Chart.js
        Chart.defaults.borderColor = '#374151'; // Set default border color

        const dataForChart = isManager
            ? myTeamMemberIds.map(id => ({ name: allUsers.find(u=>u.id===id)?.name || '?', total: expenses.filter(e=>e.employeeId === id && e.status==='APPROVED').reduce((s,e)=>s+e.amount,0) }))
            : allUsers.filter(u=>u.role==='MANAGER').map(mgr => ({ name: mgr.name, total: expenses.filter(e=>allUsers.find(u=>u.id===e.employeeId)?.managerId === mgr.id && e.status==='APPROVED').reduce((s,e)=>s+e.amount,0) }));

        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dataForChart.map(d => d.name),
                datasets: [{ label: 'Total Approved Spend', data: dataForChart.map(d => d.total), backgroundColor: 'rgba(139, 92, 246, 0.6)' }]
            },
            options: { 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#374151' } 
                    },
                    x: {
                        grid: { display: false }
                    }
                } 
            }
        });
        return () => chart.destroy();
    }, [expenses, allUsers, isManager, myTeamMemberIds]);

    function handleApproval(expenseId, approved) {
        // This is a mock update. In a real app, you would send this to the backend.
        setExpenses(exps => exps.map(exp => exp.id === expenseId ? { ...exp, status: approved ? "APPROVED" : "REJECTED" } : exp));
    }
    
    const handleAddUser = (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        // This is a mock update. In a real app, you would send this to the backend.
        const newUser = {
            id: Date.now(),
            name: formData.get('name'), email: formData.get('email'), password: "password123",
            role: formData.get('role'), managerId: formData.get('role') === 'EMPLOYEE' && loggedInUser.role === 'MANAGER' ? loggedInUser.id : null
        };
        setUsers(currentUsers => [...currentUsers, newUser]);
        e.target.reset();
    };

    return (
        <div className="dashboard">
            <div className="summary-cards" style={{ gridColumn: '1 / -1' }}>
                <div className="summary-card"><div className="value">{formatCurrency(pendingValue)}</div><div className="label">Pending Approval</div></div>
                <div className="summary-card"><div className="value">{formatCurrency(approvedValue)}</div><div className="label">Approved This Month</div></div>
                <div className="summary-card"><div className="value">{isManager ? myTeamMemberIds.length : allUsers.length}</div><div className="label">{isManager ? 'Direct Reports' : 'Total Users'}</div></div>
            </div>

            <div className="card">
                <h2>{isManager ? 'Team' : 'Company'} Budget</h2>
                <div style={{display:'flex', gap:'1rem', alignItems:'center', marginBottom:'1rem'}}>
                    <input type="number" value={budgetInput} onChange={e => setBudgetInput(e.target.value)} style={{flex:1}} />
                    <button className="approve-btn" onClick={() => setMonthlyBudget(Number(budgetInput))}>Set</button>
                </div>
                {/* Visual budget bar */}
            </div>

            <div className="card">
                <h2>{isManager ? 'Team Spending' : 'Manager Spending'}</h2>
                <canvas ref={chartRef}></canvas>
            </div>

            <div className="card">
                <h2>Approval Queue</h2>
                {pendingExpenses.length > 0 ? (
                    <ul>{pendingExpenses.map(exp => (
                        <li key={exp.id}>
                            <span>{(allUsers.find(u=>u.id===exp.employeeId) || {}).name}: {exp.name} for {formatCurrency(exp.amount)}</span>
                            <div>
                                <button className="approve-btn" onClick={() => handleApproval(exp.id, true)}>Approve</button>
                                <button className="reject-btn" onClick={() => handleApproval(exp.id, false)}>Reject</button>
                            </div>
                        </li>
                    ))}</ul>
                ) : <p>No expenses to approve.</p>}
            </div>

             {loggedInUser.role === 'ADMIN' && (
                 <div className="card">
                     <h2>User Management</h2>
                     <ul style={{maxHeight: '200px', overflowY: 'auto', marginBottom: '1rem'}}>{allUsers.map(u => <li key={u.id}>{u.name} ({u.role})</li>)}</ul>
                     <form onSubmit={handleAddUser}>
                         <h3>Add New User</h3>
                         <input name="name" placeholder="Full Name" required />
                         <input name="email" placeholder="Email" type="email" required />
                         <select name="role" required>
                             <option value="EMPLOYEE">Employee</option><option value="MANAGER">Manager</option><option value="ADMIN">Admin</option>
                         </select>
                         <button type="submit" className="approve-btn" style={{width: '100%', marginLeft: 0}}>Add User</button>
                     </form>
                 </div>
            )}
        </div>
    );
}

function Dashboard({ loggedInUser, authToken, onLogout }) {
    // These states now live here and are fetched from the backend
    const [users, setUsers] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [error, setError] = useState('');

    useEffect(() => {
        const fetchData = async () => {
            if (!authToken || loggedInUser.role === 'EMPLOYEE') return;
            setError('');
            try {
                // Fetch all users and all expenses (for admin/manager view)
                const [usersRes, expensesRes] = await Promise.all([
                    fetch(`${API_URL}/users/`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                    fetch(`${API_URL}/approvals/all`, { headers: { 'Authorization': `Bearer ${authToken}` } }) // Assuming an endpoint that gets all expenses
                ]);
                
                if (!usersRes.ok || !expensesRes.ok) {
                    throw new Error('Failed to fetch dashboard data.');
                }
                
                const usersData = await usersRes.json();
                const expensesData = await expensesRes.json();

                setUsers(usersData);
                setExpenses(expensesData);

            } catch (err) {
                setError('Could not load dashboard data. ' + err.message);
            }
        };
        fetchData();
    }, [authToken, loggedInUser]);


    return (
        <div className="dashboard-wrapper">
            <div style={{ textAlign: "center", marginBottom: "24px" }}>
                <h1>LedgerCore</h1>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 10px'}}>
                    <p>Welcome, <strong>{loggedInUser.name}</strong> ({loggedInUser.role})</p>
                    <button onClick={onLogout} className="logout-btn" style={{margin: 0}}>Logout</button>
                </div>
            </div>
            {error && <div className="message error">{error}</div>}
            {loggedInUser.role === 'EMPLOYEE' ? (
                <EmployeeDashboardPro loggedInUser={loggedInUser} />
            ) : (
                <ManagerAdminDashboard 
                    loggedInUser={loggedInUser} 
                    allUsers={users} 
                    setUsers={setUsers} 
                    expenses={expenses} 
                    setExpenses={setExpenses} 
                    authToken={authToken}
                />
            )}
        </div>
    );
}

// --- MAIN APP CONTROLLER ---
function App() {
  const [view, setView] = useState('landing');
  const [loggedInUser, setLoggedInUser] = useState(null);
  const [authToken, setAuthToken] = useState(null);
  const [error, setError] = useState('');
 
  const handleSignUp = async (newUser) => {
    if (newUser.password !== newUser.confirmPassword) {
        setError("Passwords do not match.");
        return;
    }
    setError('');

    try {
        const response = await fetch(`${API_URL}/auth/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: newUser.name,
                email: newUser.email,
                role: newUser.role,
                password: newUser.password
            })
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.detail || "Signup failed.");
        }
        
        setView('login');
        // Use a non-error message state in a real app, but for now this works.
        setError("Account created successfully! Please log in."); 

    } catch (err) {
        setError(err.message);
    }
  };

  const handleLogin = async (email, password) => {
    setError('');
    const formData = new URLSearchParams();
    formData.append('username', email); // FastAPI's OAuth2 form expects 'username' for the email
    formData.append('password', password);

    try {
        const response = await fetch(`${API_URL}/auth/token`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.detail || "Invalid credentials.");
        }
        
        const data = await response.json();
        setAuthToken(data.access_token);
        
        // Fetch user details right after getting token
        const userResponse = await fetch(`${API_URL}/users/me`, {
            headers: { 'Authorization': `Bearer ${data.access_token}` }
        });

        if (!userResponse.ok) throw new Error('Could not fetch user profile.');
        
        const userData = await userResponse.json();
        setLoggedInUser(userData);
        setView('dashboard');

    } catch (err) {
        setError(err.message);
    }
  };
 
  const handleLogout = () => {
      setLoggedInUser(null);
      setAuthToken(null);
      setView('landing');
  };
 
  useEffect(() => {
    const handleMessage = async (event) => {
        if (event.data && event.data.type === 'SUBMIT_EXPENSES' && authToken) {
            const expensesFromEmployee = event.data.payload;
            
            try {
                // Use Promise.all to send all expenses concurrently
                const results = await Promise.all(expensesFromEmployee.map(exp => 
                    fetch(`${API_URL}/expenses/`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}` 
                        },
                        body: JSON.stringify({ 
                            name: exp.name, 
                            amount: exp.amount, 
                            category: exp.category,
                            // The backend will handle the date
                        })
                    })
                ));

                // Check if all requests were successful
                const allOk = results.every(res => res.ok);
                if (allOk) {
                    alert('All expenses submitted successfully!');
                } else {
                    throw new Error('Some expenses failed to submit.');
                }
                
            } catch (err) {
                alert('Error submitting expenses: ' + err.message);
            }
        }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [authToken]);
 
  const renderView = () => {
      switch(view) {
          case 'landing': return <LandingPage switchToSignUp={() => setView('signup')} switchToLogin={() => setView('login')} />;
          case 'dashboard': return <Dashboard loggedInUser={loggedInUser} authToken={authToken} onLogout={handleLogout} />;
          case 'login': return <LoginPage onLogin={handleLogin} switchToSignUp={() => { setView('signup'); setError(''); }} error={error} />;
          case 'signup': default: return <SignUpPage onSignUp={handleSignUp} switchToLogin={() => { setView('login'); setError(''); }} error={error} />;
      }
  };

  return (
    <div key={view} className="view-container">
        {renderView()}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>